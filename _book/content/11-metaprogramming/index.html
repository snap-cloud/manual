<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A manual for Snap! TODO">

<title>11&nbsp; Metaprogramming – Snap! Reference Manual</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../content/12-user-interface-elements/index.html" rel="next">
<link href="../../content/10-continuations/index.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-c09c9fbbb0eb80a11083d72da712c037.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://snap.berkeley.edu/" class="navbar-brand navbar-brand-logo">
    <img src="../../images/snap-logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="https://snap.berkeley.edu/">
    <span class="navbar-title">Snap! Reference Manual</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
    <a href="https://github.com/snap-cloud/snap-manual/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../../snap-manual.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/11-metaprogramming/index.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Metaprogramming</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../images/snap-logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Snap! Reference Manual</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/00-acknowledgements/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/01-blocks-scripts-and-sprites/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Blocks, Scripts, and Sprites</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/02-saving-and-loading-projects-and/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Saving and Loading Projects and Media</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/03-building-a-block/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Building a Block</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/04-first-class-lists/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">First class lists</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/05-typed-inputs/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Typed Inputs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/06-procedures-as-data/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Procedures as Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/07-object-oriented-programming-with-sprites/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Object Oriented Programming with Sprites</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/08-oop-with-procedures/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">OOP with Procedures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/09-the-outside-world/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The Outside World</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/10-continuations/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Continuations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/11-metaprogramming/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Metaprogramming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/12-user-interface-elements/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">User Interface Elements <span></span></span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/13-appendix-a-snap-color-library/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Appendix A. Snap<em>!</em> color library</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/14-appendix-b-apl-features/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Appendix B. APL features</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/index-list.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Index</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/definition-of-blocks/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Definitions of Each Block in Snap<strong>!</strong></span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#reading-a-block" id="toc-reading-a-block" class="nav-link active" data-scroll-target="#reading-a-block">Reading a block</a></li>
  <li><a href="#writing-a-block" id="toc-writing-a-block" class="nav-link" data-scroll-target="#writing-a-block">Writing a block</a></li>
  <li><a href="#macros" id="toc-macros" class="nav-link" data-scroll-target="#macros">Macros</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/snap-cloud/snap-manual/edit/main/content/11-metaprogramming/index.md" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Metaprogramming</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The scripts and custom blocks that make up a program can be examined or created by the program itself.</p>
<section id="reading-a-block" class="level2">
<h2 class="anchored" data-anchor-id="reading-a-block">Reading a block</h2>
<p><img src="assets/image375.png" class="img-fluid" alt="image375.png"> <!--  style="width:1.15in;height:0.19in" alt="A picture containing text, hitting Description automatically generated" / --></p>
<p>The definition of block <span></span> takes a custom block (in a ring, since it’s the block itself that’s the input, not the result of calling the block) as input and reports the block’s definition, i.e., its inputs and body, in the form of a ring with named inputs corresponding to the block’s input names, so that those input names are bound in the body.</p>
<p>The split by blocks block <span></span> takes any expression or script as input (ringed) and reports a list representing a <em>syntax tree</em> for the script or expression, in which the first item is a block with no inputs and the remaining items are the input values, which may themselves be syntax trees.</p>
<p><img src="assets/image377.png" class="img-fluid" alt="image377.png"> <!--  style="width:1.15in;height:0.19in" alt="A picture containing text, hitting Description automatically generated" / --></p>
<p>Using split by blocks to select custom blocks whose definitions contain another block gives us this debugging aid:</p>
<p><img src="assets/image378.png" class="img-fluid" alt="image378.png"> <!--  style="width:1.15in;height:0.19in" alt="A picture containing text, hitting Description automatically generated" / --></p>
<p>Note in passing the my blocks block <span></span>, which reports a list of all visible blocks, primitive and custom. (There’s also a my categories block <span></span>, which reports a list of the names of the palette categories.) Also note custom? of block <span></span>, which reports True if its input is a custom block.</p>
</section>
<section id="writing-a-block" class="level2">
<h2 class="anchored" data-anchor-id="writing-a-block">Writing a block</h2>
<p>The inverse function to split by blocks is provided by the join block <span></span>, which when given a syntax tree as input reports the corresponding expression or script.</p>
<p><img src="assets/image379.png" class="img-fluid" alt="image379.png"> <!--  style="width:1.15in;height:0.19in" alt="A picture containing text, hitting Description automatically generated" / --></p>
<p>Here we are taking the definition of square, modifying the repetition count (to 6), modifying the turning angle (to 60), using join to turn the result back into a ringed definition, and using the define block <span></span> to create a new hexagon block.</p>
<p>The define block has three “input” slots. The quotation marks are there because the first slot is an upvar, i.e., a way for define to provide information to its caller, rather than the other way around. In this case, the value of block is the new block itself (the hexagon block, in this example). The second slot is where you give the <em>label</em> for the new block. In this example, the label is “hexagon _” in which the underscore represents an input slot. So, here are a few examples of block label <span></span> s:</p>
<p>set pen _ to _</p>
<p>for _ = _ to _ _</p>
<p>ask _ and wait</p>
<p>_ of _</p>
<p>Note that the underscores are separated from the block text by spaces. Note in the case of the for block’s label that the upvar (the i) and the C-slot both count as inputs. Note also that the label is not meant to be a unique symbol that represents only this block. For example, <img src="assets/image628.png" class="img-fluid" alt="image628.png"> <!--  style="width:0.86111in;height:0.19444in" / --> and <img src="assets/image376.png" class="img-fluid" alt="image376.png"> <!--  style="width:1.15in;height:0.19in" alt="A picture containing text, hitting Description automatically generated" / --> both have the label</p>
<p>_ of _. The label does not give the input slots names (that’s done in the body, coming next) or types (that’s done in the set _ of block _ to _ block <span></span>, coming in two paragraphs).</p>
<p>The third slot is for the <em>definition</em> <span></span> of the new block. This is a (ringed) script whose input names (formal parameters) will become the formal parameters of the new block. And the script is its script.</p>
<p>So far we know the block’s label, parameters, and script. There are other things to specify about the block, and one purpose of the block upvar is to allow that. In the example on the previous page, there are four set _ of block _ to _ blocks, reproduced below for your convenience:</p>
<p><img src="assets/image951.png" class="img-fluid" alt="image951.png"> <!--  style="width:2.83in;height:0.97in" alt="Graphical user interface, website Description automatically generated" / --></p>
<p>The category of the block can be set to any primitive or custom category. The default is other. The type is command, reporter, or predicate. Command is the default, so this setting is redundant, but we want to show all the choices in the set block. The scope is either global or sprite, with global as the default. The last input to set slots is a list of length less than or equal to the number of underscores in the label. Each item of the list is a type name, like the ones in the is (5) a (number)? block. If there is only one input, you can use just the name instead of putting it in a list. An empty or missing list item means type Any.</p>
<p>It’s very important that these set blocks appear in the same script as the define that creates the block, because the block upvar is local to that script. You can’t later say, for example,</p>
<p><img src="assets/image952.png" class="img-fluid" alt="image952.png"> <!--  style="width:4.31in;height:0.83in" alt="Graphical user interface, text, application, chat or text message Description automatically generated" / --></p>
<p>because the copy of the hexagon block in this instruction counts as “using” it.</p>
<p><img src="assets/image953.png" class="img-fluid" alt="image953.png"> <!--  style="width:2.6in;height:0.32in" / --></p>
<p>The of block reporter is useful to copy attributes from one block to another, as we copied the definition of square, modified it, and used it to define hexagon. Some of the values this block reports are a little unfriendly:</p>
<p>“1”? Yes, this block reports <em>numbers</em> instead of names for category, type, and scope. The reason is that maybe someday we’ll have translations to other languages for custom category names, as we already do for the built-in categories, types, and scopes; if you translate a program using this block to another language, the numeric outputs won’t change, simplifying comparisons in your code. The set block accepts these numbers as an alternative to the names.</p>
<p>There are a few more attributes of a block, less commonly used.</p>
<p><img src="assets/image954.png" class="img-fluid" alt="image954.png"> <!--  style="width:3.37986in;height:0.37986in" / --> <img src="assets/image955.png" class="img-fluid" alt="image955.png"> <!--  style="width:1.02in;height:0.25in" alt="A picture containing text, clipart Description automatically generated" / --></p>
<p>The list input is just like the one for set slots except for default values instead of types. Now for a block with a menu input:</p>
<p><img src="assets/image961.png" class="img-fluid" alt="image961.png"> <!--  style="width:3.29097in;height:0.60972in" / --></p>
<p><img src="assets/image962.png" class="img-fluid" alt="image962.png"> <!--  style="width:2.35in;height:2.56in" alt="Graphical user interface, application Description automatically generated" / --></p>
<p><img src="assets/image965.png" class="img-fluid" alt="image965.png"> <!--  style="width:1.66944in;height:0.25in" alt="Graphical user interface, text, application Description automatically generated" / --></p>
<p>Prefer a read-only menu?</p>
<p><img src="assets/image956.png" class="img-fluid" alt="image956.png"> <!--  style="width:3.51944in;height:0.61944in" alt="Graphical user interface, text, website Description automatically generated" / --></p>
<p><img src="assets/image963.png" class="img-fluid" alt="image963.png"> <!--  style="width:1.66944in;height:0.25in" alt="Graphical user interface, text, application Description automatically generated" / --></p>
<p>We passed too quickly over how the script turned the square block into a hexagon block:</p>
<p><img src="assets/image964.png" class="img-fluid" alt="image964.png"> <!--  style="width:4.16944in;height:1.26944in" alt="Graphical user interface, website Description automatically generated" / --></p>
<p>Those replace item blocks aren’t very elegant. I had to look at foo by hand to figure out where the numbers I wanted to change are. This situation can be improved with a little programming:</p>
<p><img src="assets/image966.png" class="img-fluid" alt="image966.png"> <!--  style="width:4.16944in;height:1.26944in" alt="Graphical user interface, website Description automatically generated" / --></p>
<p>Exercise for the reader: Implement this:</p>
<p><img src="assets/image971.png" class="img-fluid" alt="image971.png"> <!--  style="width:3.11in;height:0.57in" alt="Graphical user interface Description automatically generated" / --></p>
<p>Returning to the define block, there’s another reason for the block upvar: It’s helpful in defining a recursive procedure using define <span></span>. For a procedure to call itself, it needs a name for itself. But in the definition input to the define block, define itself hasn’t been called yet, so the new block isn’t in the palette yet. So you do this:</p>
<p><img src="assets/image972.png" class="img-fluid" alt="image972.png"> <!--  style="width:3.11in;height:0.57in" alt="Graphical user interface Description automatically generated" / --></p>
<p>Yes, you put block in the define, but it gets changed into this script in the resulting definition.</p>
<p><img src="assets/image973.png" class="img-fluid" alt="image973.png"> <!--  style="width:3.11in;height:0.57in" alt="Graphical user interface Description automatically generated" / --></p>
<p><img src="assets/image974.png" class="img-fluid" alt="image974.png"> <!--  style="width:3.11in;height:0.57in" alt="Graphical user interface Description automatically generated" / --></p>
<p><img src="assets/image975.png" class="img-fluid" alt="image975.png"> <!--  style="width:3.11in;height:0.57in" alt="Graphical user interface Description automatically generated" / --></p>
<p>You could use this script directly in a simple case like this, but in a complicated case with a recursive call inside a ring inside the one giving the block definition, this script always means the innermost ring. But the upvar means the outer ring; note how the definition of blockify automatically creates a script variable to hold the outer environment.</p>
<p>It’s analogous to using explicit formal parameters when you nest calls to higher order functions.</p>
<p>Note: Ordinarily, when you call a function that reports a (ringed) procedure, that procedure was created in some specific environment, and has access to that environment’s variables. This is how instance variables (fields) work in object oriented programming (Chapter VIII). But the procedures made by join of a syntax tree have no associated environment, not even the one containing global variables. That doesn’t matter if the procedure will use only its own input variables, but for access to other variables, use</p>
</section>
<section id="macros" class="level2">
<h2 class="anchored" data-anchor-id="macros">Macros</h2>
<p><img src="assets/image976.png" class="img-fluid" alt="image976.png"> <!--  style="width:3.11in;height:0.57in" alt="Graphical user interface Description automatically generated" / --></p>
<p>Users of languages in the C family have learned to think of macros as entirely about text strings, with no relation to the syntax of the language. So you can do things like</p>
<p>#define foo baz)</p>
<p>with the result that you can only use the foo macro after an open parenthesis.</p>
<p>In the Lisp family of languages we have a different tradition, in which macros <span></span> are syntactically just like procedure calls, except that the “procedure” is a macro, with different evaluation rules from ordinary procedures. Two things make a macro different: its input expressions are not evaluated, so a macro can establish its own syntax (but still delimited by parentheses, in Lisp, or still one block, in Snap<em>!</em> ); and the result of a macro call is a new expression that is evaluated <em>as if it appeared in the caller</em> of the macro, with access to the caller’s variables and, implicitly, its continuation.</p>
<p>Snap<em>!</em> has long had the first part of this, the ability to make inputs unevaluated. In version 8.0 we add the ability to run code in the context of another procedure, just as we can run code in the context of another sprite, using the same mechanism: the of block <span></span> . In the example on the previous page, the if _ report _ caller _ block runs a report block, but not in its own context; it causes <em>the fizzbuzz block</em> to report “fizz” or “buzz” as appropriate. (Yes, we know that the rules implemented here are simplified compared to the real game.) It doesn’t just report out of the entire toplevel script; you can see that map is able to prepend “The answer is” to each reported value.</p>
<p><img src="assets/image992.png" class="img-fluid" alt="image992.png"> <!--  style="width:3.03958in;height:0.23958in" / --></p>
<p>This macro capability isn’t fully implemented. First, we shouldn’t have to use the calling script as an explicit input to the macro. In a later release, this will be fixed; when defining a block you’ll be able to say that it’s a macro, and it will automatically get its caller’s context as an invisible input. Second, there is a possibility of confusion between the variables of the macro and the variables of its caller. (What if the macro wanted to refer to a variable value in its caller?) The one substantial feature of Scheme that we don’t yet implement is <em>hygienic macros,</em> which make it possible to keep the two namespaces separate.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../content/10-continuations/index.html" class="pagination-link" aria-label="Continuations">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Continuations</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../content/12-user-interface-elements/index.html" class="pagination-link" aria-label="User Interface Elements \index{user interface elements}">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">User Interface Elements <span></span></span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/snap-cloud/snap-manual/edit/main/content/11-metaprogramming/index.md" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>